name: Lab CI (NUC + snakeburger verification)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  orchestrated-lab-ci:
    runs-on: [self-hosted, linux, x64]

    steps:
      - name: Checkout repo into workspace
        uses: actions/checkout@v4

      - name: Debug where we are
        run: |
          set -euo pipefail
          echo "Workspace: $GITHUB_WORKSPACE"
          pwd
          ls -la
          git rev-parse --short HEAD

      - name: Pre-clean NUC repo to remove stale files
        run: |
          set -euo pipefail
          NUC_REPO="${HOME}/surfworks/warpforge"
          if [[ -d "$NUC_REPO/.git" ]]; then
            echo "Pre-cleaning NUC repo at $NUC_REPO"
            cd "$NUC_REPO"

            # Check .git size before cleanup
            GIT_SIZE_BEFORE=$(du -sm .git | cut -f1)
            echo ".git directory size before: ${GIT_SIZE_BEFORE} MB"

            git fetch origin
            git reset --hard "origin/${GITHUB_REF_NAME:-main}"

            # Remove ALL untracked/ignored files except venvs, gradle caches, and GraalPy tools
            git clean -fdx -e '.pytorch-venv' -e '.gradle' -e 'snakegrinder-dist/tools'

            # If .git is bloated (>50MB), clean up stale objects from force pushes
            if [[ "$GIT_SIZE_BEFORE" -gt 50 ]]; then
              echo "WARNING: .git directory is ${GIT_SIZE_BEFORE} MB (>50MB threshold)"
              echo "Running git gc to clean up stale objects from history rewrites..."
              git reflog expire --expire=now --all
              git gc --prune=now --aggressive
              GIT_SIZE_AFTER=$(du -sm .git | cut -f1)
              echo ".git directory size after gc: ${GIT_SIZE_AFTER} MB"
              echo "Reclaimed: $((GIT_SIZE_BEFORE - GIT_SIZE_AFTER)) MB"
            fi

            echo "Pre-clean complete. Git status:"
            git status

            # Final .git size check
            GIT_SIZE_FINAL=$(du -sm .git | cut -f1)
            echo "Final .git size: ${GIT_SIZE_FINAL} MB"
            if [[ "$GIT_SIZE_FINAL" -gt 100 ]]; then
              echo "ERROR: .git directory is still ${GIT_SIZE_FINAL} MB after cleanup!"
              echo "This may indicate large files were accidentally committed."
              echo "Consider running: git filter-repo to clean history"
              exit 1
            fi
          else
            echo "NUC repo not found at $NUC_REPO, will be cloned by orchestrate script"
          fi

      - name: Run orchestrate script from repo
        run: |
          set -euo pipefail
          chmod +x holmes-lab/mark1/ci-scripts/*.sh
          bash holmes-lab/mark1/ci-scripts/orchestrate-nuc-build.sh

      - name: Verify snakeburger-core test execution
        run: |
          set -euo pipefail
          echo "=== Checking snakeburger-core test results ==="

          # The orchestrate script runs in ~/surfworks/warpforge, not GITHUB_WORKSPACE
          NUC_REPO="${HOME}/surfworks/warpforge"
          TEST_RESULTS_DIR="${NUC_REPO}/snakeburger-core/build/test-results/test"

          echo "Checking test results in: ${TEST_RESULTS_DIR}"

          if [[ -d "$TEST_RESULTS_DIR" ]]; then
            TEST_COUNT=$(find "$TEST_RESULTS_DIR" -name "*.xml" -exec grep -h "tests=" {} \; | grep -oE 'tests="[0-9]+"' | grep -oE '[0-9]+' | awk '{sum+=$1} END {print sum}')
            echo "snakeburger-core test count: ${TEST_COUNT:-0}"

            if [[ "${TEST_COUNT:-0}" -lt 300 ]]; then
              echo "ERROR: Expected at least 300 snakeburger-core tests but found ${TEST_COUNT:-0}"
              echo "This suggests tests were skipped. Check Babylon JDK availability."
              exit 1
            fi

            echo "SUCCESS: snakeburger-core tests executed (${TEST_COUNT} tests)"
          else
            echo "ERROR: No test results found at ${TEST_RESULTS_DIR}"
            echo ""
            echo "snakeburger-core tests require Babylon JDK (Java 26)."
            echo "To fix this on the NUC, run:"
            echo "  cd ~/surfworks"
            echo "  git clone https://github.com/openjdk/babylon.git"
            echo "  cd babylon"
            echo "  bash configure"
            echo "  make images"
            echo ""
            echo "Checking if Babylon exists..."
            if [[ -d "${HOME}/surfworks/babylon/build" ]]; then
              echo "Babylon build dir exists. Looking for javac..."
              find "${HOME}/surfworks/babylon/build" -name "javac" -type f 2>/dev/null | head -3 || echo "No javac found!"
            else
              echo "Babylon NOT found at ${HOME}/surfworks/babylon"
            fi
            exit 1
          fi

      - name: Verify warpforge-io test execution
        run: |
          set -euo pipefail
          echo "=== Checking warpforge-io test results ==="

          NUC_REPO="${HOME}/surfworks/warpforge"
          TEST_RESULTS_DIR="${NUC_REPO}/warpforge-io/build/test-results/test"

          echo "Checking test results in: ${TEST_RESULTS_DIR}"

          if [[ -d "$TEST_RESULTS_DIR" ]]; then
            TEST_COUNT=$(find "$TEST_RESULTS_DIR" -name "*.xml" -exec grep -h "tests=" {} \; | grep -oE 'tests="[0-9]+"' | grep -oE '[0-9]+' | awk '{sum+=$1} END {print sum}')
            echo "warpforge-io test count: ${TEST_COUNT:-0}"

            # warpforge-io should have at least 150 tests (RDMA, Collective, VirtualThreads, etc.)
            if [[ "${TEST_COUNT:-0}" -lt 150 ]]; then
              echo "ERROR: Expected at least 150 warpforge-io tests but found ${TEST_COUNT:-0}"
              echo "This suggests tests were skipped or failed to compile."
              exit 1
            fi

            echo "SUCCESS: warpforge-io tests executed (${TEST_COUNT} tests)"
          else
            echo "ERROR: No test results found at ${TEST_RESULTS_DIR}"
            echo "warpforge-io tests should run with standard JDK 25."
            exit 1
          fi

      - name: Verify warpforge-core test execution
        run: |
          set -euo pipefail
          echo "=== Checking warpforge-core test results ==="

          NUC_REPO="${HOME}/surfworks/warpforge"
          TEST_RESULTS_DIR="${NUC_REPO}/warpforge-core/build/test-results/test"

          echo "Checking test results in: ${TEST_RESULTS_DIR}"

          if [[ -d "$TEST_RESULTS_DIR" ]]; then
            TEST_COUNT=$(find "$TEST_RESULTS_DIR" -name "*.xml" -exec grep -h "tests=" {} \; | grep -oE 'tests="[0-9]+"' | grep -oE '[0-9]+' | awk '{sum+=$1} END {print sum}')
            echo "warpforge-core test count: ${TEST_COUNT:-0}"

            # warpforge-core should have at least 100 tests
            if [[ "${TEST_COUNT:-0}" -lt 100 ]]; then
              echo "ERROR: Expected at least 100 warpforge-core tests but found ${TEST_COUNT:-0}"
              echo "This suggests tests were skipped or failed to compile."
              exit 1
            fi

            echo "SUCCESS: warpforge-core tests executed (${TEST_COUNT} tests)"
          else
            echo "ERROR: No test results found at ${TEST_RESULTS_DIR}"
            exit 1
          fi

      - name: Run ptest JFR event emission tests
        run: |
          set -euo pipefail
          echo "=== Running ptest JFR event emission tests ==="

          NUC_REPO="${HOME}/surfworks/warpforge"
          cd "$NUC_REPO"

          # Run ptest unit tests - these verify JFR event capture without GPU hardware
          ./gradlew :ptest:test --no-daemon

          echo "=== Checking ptest results ==="
          TEST_RESULTS_DIR="${NUC_REPO}/ptest/build/test-results/test"

          if [[ -d "$TEST_RESULTS_DIR" ]]; then
            TEST_COUNT=$(find "$TEST_RESULTS_DIR" -name "*.xml" -exec grep -h "tests=" {} \; | grep -oE 'tests="[0-9]+"' | grep -oE '[0-9]+' | awk '{sum+=$1} END {print sum}')
            echo "ptest JFR event emission test count: ${TEST_COUNT:-0}"

            # ptest should have at least 4 JFR event emission tests
            if [[ "${TEST_COUNT:-0}" -lt 4 ]]; then
              echo "ERROR: Expected at least 4 ptest JFR tests but found ${TEST_COUNT:-0}"
              exit 1
            fi

            echo "SUCCESS: ptest JFR event emission tests passed (${TEST_COUNT} tests)"
          else
            echo "ERROR: No test results found at ${TEST_RESULTS_DIR}"
            exit 1
          fi
