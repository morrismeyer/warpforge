name: Lab CI (NUC orchestrator baseline)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  orchestrated-lab-ci:
    runs-on: [self-hosted, linux, x64]

    steps:
      - name: Checkout repo into workspace
        uses: actions/checkout@v4

      - name: Debug where we are
        run: |
          set -euo pipefail
          echo "Workspace: $GITHUB_WORKSPACE"
          pwd
          ls -la
          git rev-parse --short HEAD

      - name: Run orchestrate script from repo
        run: |
          set -euo pipefail
          chmod +x holmes-lab/mark1/ci-scripts/*.sh
          bash holmes-lab/mark1/ci-scripts/orchestrate-nuc-build.sh

      - name: Verify snakeburger-core test execution
        run: |
          set -euo pipefail
          echo "=== Checking snakeburger-core test results ==="

          # The orchestrate script runs in ~/surfworks/warpforge, not GITHUB_WORKSPACE
          NUC_REPO="${HOME}/surfworks/warpforge"
          TEST_RESULTS_DIR="${NUC_REPO}/snakeburger-core/build/test-results/test"

          echo "Checking test results in: ${TEST_RESULTS_DIR}"

          if [[ -d "$TEST_RESULTS_DIR" ]]; then
            TEST_COUNT=$(find "$TEST_RESULTS_DIR" -name "*.xml" -exec grep -h "tests=" {} \; | grep -oE 'tests="[0-9]+"' | grep -oE '[0-9]+' | awk '{sum+=$1} END {print sum}')
            echo "snakeburger-core test count: ${TEST_COUNT:-0}"

            if [[ "${TEST_COUNT:-0}" -lt 300 ]]; then
              echo "ERROR: Expected at least 300 snakeburger-core tests but found ${TEST_COUNT:-0}"
              echo "This suggests tests were skipped. Check Babylon JDK availability."
              exit 1
            fi

            echo "SUCCESS: snakeburger-core tests executed (${TEST_COUNT} tests)"
          else
            echo "ERROR: No test results found at ${TEST_RESULTS_DIR}"
            echo ""
            echo "snakeburger-core tests require Babylon JDK (Java 26)."
            echo "To fix this on the NUC, run:"
            echo "  cd ~/surfworks"
            echo "  git clone https://github.com/openjdk/babylon.git"
            echo "  cd babylon"
            echo "  bash configure"
            echo "  make images"
            echo ""
            echo "Checking if Babylon exists..."
            if [[ -d "${HOME}/surfworks/babylon/build" ]]; then
              echo "Babylon build dir exists. Looking for javac..."
              find "${HOME}/surfworks/babylon/build" -name "javac" -type f 2>/dev/null | head -3 || echo "No javac found!"
            else
              echo "Babylon NOT found at ${HOME}/surfworks/babylon"
            fi
            exit 1
          fi
