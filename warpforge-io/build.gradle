/*
 * warpforge-io: High-performance RDMA networking for WarpForge.
 *
 * Provides zero-copy data transfer between nodes using UCX/UCC libraries
 * with Java FFM bindings. Supports AI/ML collective operations (allreduce, etc.)
 * over Mellanox 100GbE InfiniBand/RoCE hardware.
 */

plugins {
    id 'java-library'
}

group = 'io.surfworks.warpforge'
version = '0.0.1-SNAPSHOT'

repositories {
    mavenCentral()
}

// ===== Source Sets =====

sourceSets {
    main {
        java {
            // Only include generated source if it exists
            def generatedDir = file('src/generated/java')
            if (generatedDir.exists()) {
                srcDirs = ['src/main/java', 'src/generated/java']
            } else {
                srcDirs = ['src/main/java']
            }
        }
    }
}

// ===== Dependencies =====

dependencies {
    // Core WarpForge (for Tensor, MemorySegment integration)
    api project(':warpforge-core')

    // Jackson for configuration serialization
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.17.0'

    // Testing
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.2'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    // Ray integration for distributed tests
    testImplementation project(':warpforge-launch-core')
}

// ===== Java Configuration =====

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
    options.compilerArgs.addAll([
        '--enable-preview',
        '--add-modules', 'jdk.incubator.vector'
    ])
}

// ===== FFM Native Access =====

tasks.withType(JavaExec).configureEach {
    jvmArgs '--enable-native-access=ALL-UNNAMED', '--enable-preview'
}

tasks.withType(Test).configureEach {
    jvmArgs '--enable-native-access=ALL-UNNAMED', '--enable-preview'

    // Support for forcing mock mode via command line
    // Usage: ./gradlew test -Dwarpforge.collective.mode=mock -Dwarpforge.rdma.mode=mock
    def collectiveMode = System.getProperty('warpforge.collective.mode')
    if (collectiveMode != null) {
        systemProperty 'warpforge.collective.mode', collectiveMode
    }
    def rdmaMode = System.getProperty('warpforge.rdma.mode')
    if (rdmaMode != null) {
        systemProperty 'warpforge.rdma.mode', rdmaMode
    }
}

// ===== Test Configuration =====

test {
    useJUnitPlatform {
        // Exclude integration and performance tests from normal test run
        excludeTags 'integration', 'rdma', 'rdma-perf', 'ray-integration'
    }

    testLogging {
        events 'passed', 'skipped', 'failed'
        showStandardStreams = true
    }
}

// Unit tests run on NUC with mocks (no RDMA hardware required)
tasks.register('unitTest', Test) {
    description = 'Run unit tests with mock backends (can run on NUC without RDMA)'
    group = 'verification'

    testClassesDirs = sourceSets.test.output.classesDirs
    classpath = sourceSets.test.runtimeClasspath

    useJUnitPlatform {
        includeTags 'unit'
        excludeTags 'integration', 'rdma', 'rdma-perf', 'ray-integration'
    }

    systemProperty 'warpforge.rdma.mode', 'mock'
    systemProperty 'warpforge.collective.mode', 'mock'
}

// RDMA tests require actual hardware
tasks.register('rdmaTest', Test) {
    description = 'Run RDMA tests (requires Mellanox hardware)'
    group = 'verification'

    testClassesDirs = sourceSets.test.output.classesDirs
    classpath = sourceSets.test.runtimeClasspath

    useJUnitPlatform {
        includeTags 'rdma'
        excludeTags 'rdma-perf', 'ray-integration'
    }

    // Longer timeout for hardware tests
    systemProperty 'junit.jupiter.execution.timeout.default', '5m'
}

// Performance tests
tasks.register('rdmaPerfTest', Test) {
    description = 'Run RDMA performance tests (measures throughput vs ibperf baseline)'
    group = 'verification'

    // Must set test classes and classpath for custom Test tasks
    testClassesDirs = sourceSets.test.output.classesDirs
    classpath = sourceSets.test.runtimeClasspath

    useJUnitPlatform {
        includeTags 'rdma-perf'
    }

    // Much longer timeout for perf tests
    systemProperty 'junit.jupiter.execution.timeout.default', '30m'

    // Performance test configuration
    systemProperty 'rdma.perf.iterations', System.getProperty('rdma.perf.iterations', '10000')
    systemProperty 'rdma.perf.message.size', System.getProperty('rdma.perf.message.size', '1048576')
    systemProperty 'rdma.server.host', System.getProperty('rdma.server.host', 'gpu-node-2')
    systemProperty 'rdma.server.port', System.getProperty('rdma.server.port', '18515')

    testLogging {
        events 'passed', 'skipped', 'failed'
        showStandardStreams = true
    }
}

// Ray-launched integration tests for distributed operations
tasks.register('rayIntegrationTest', Test) {
    description = 'Run Ray-launched integration tests for all RDMA and collective operations'
    group = 'verification'

    testClassesDirs = sourceSets.test.output.classesDirs
    classpath = sourceSets.test.runtimeClasspath

    useJUnitPlatform {
        includeTags 'ray-integration'
    }

    // Pass Ray cluster configuration
    systemProperty 'ray.address', System.getProperty('ray.address', 'auto')
    systemProperty 'rdma.world.size', System.getProperty('rdma.world.size', '2')

    // Extended timeout for distributed tests
    systemProperty 'junit.jupiter.execution.timeout.default', '15m'
}

// All integration tests
tasks.register('integrationTest', Test) {
    description = 'Run all integration tests (RDMA + Ray)'
    group = 'verification'

    testClassesDirs = sourceSets.test.output.classesDirs
    classpath = sourceSets.test.runtimeClasspath

    useJUnitPlatform {
        includeTags 'integration', 'rdma', 'ray-integration'
        excludeTags 'rdma-perf'
    }

    systemProperty 'junit.jupiter.execution.timeout.default', '10m'
}

// ===== jextract Stub Dependency =====

// Only depend on jextract stubs when building with real UCX support
// For NUC development with mocks, this dependency is skipped
tasks.named('compileJava') {
    def openucxRuntime = rootProject.findProject(':openucx-runtime')
    def generatedDir = file('src/generated/java')
    def useRealUcx = providers.gradleProperty('warpforge.io.useRealUcx')
            .orElse('false').get().toBoolean()

    if (openucxRuntime != null && useRealUcx && !generatedDir.exists()) {
        dependsOn openucxRuntime.tasks.matching { it.name == 'generateJextractStubs' }
    }
}

// ===== Native Library Path Configuration =====

def ucxLibPath = providers.gradleProperty('openucx.repo')
        .orElse(new File(rootProject.projectDir, '../openucx').absolutePath)
        .map { new File(it, 'install/lib').absolutePath }

def uccLibPath = providers.gradleProperty('ucc.repo')
        .orElse(new File(rootProject.projectDir, '../ucc').absolutePath)
        .map { new File(it, 'install/lib').absolutePath }

tasks.withType(Test).configureEach {
    def libPath = "${ucxLibPath.get()}:${uccLibPath.get()}"
    environment 'LD_LIBRARY_PATH', "${libPath}:${System.getenv('LD_LIBRARY_PATH') ?: ''}"
    // Also set java.library.path for FFM SymbolLookup to find native libraries
    systemProperty 'java.library.path', libPath
}

tasks.withType(JavaExec).configureEach {
    environment 'LD_LIBRARY_PATH', "${ucxLibPath.get()}:${uccLibPath.get()}:${System.getenv('LD_LIBRARY_PATH') ?: ''}"
}

// ===== Mellanox Smoke Test =====

// Run the Mellanox cross-connect smoke test
// Usage: ./gradlew :warpforge-io:mellanoxSmokeTest --args='server'
//        ./gradlew :warpforge-io:mellanoxSmokeTest --args='client 192.168.2.1'
//        ./gradlew :warpforge-io:mellanoxSmokeTest --args='info'
tasks.register('mellanoxSmokeTest', JavaExec) {
    description = 'Run Mellanox cross-connect smoke test (server/client/info mode)'
    group = 'verification'

    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'io.surfworks.warpforge.io.test.MellanoxSmokeTest'

    jvmArgs '--enable-native-access=ALL-UNNAMED', '--enable-preview'

    // Allow passing args via --args='...'
    // Default to 'info' if no args provided
    args = project.hasProperty('args') ? project.property('args').split(' ') : ['info']
}

// Convenience aliases
tasks.register('mellanoxInfo', JavaExec) {
    description = 'Show RDMA device information'
    group = 'verification'

    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'io.surfworks.warpforge.io.test.MellanoxSmokeTest'
    jvmArgs '--enable-native-access=ALL-UNNAMED', '--enable-preview'
    args 'info'
}

tasks.register('mellanoxServer', JavaExec) {
    description = 'Run Mellanox smoke test in server mode'
    group = 'verification'

    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'io.surfworks.warpforge.io.test.MellanoxSmokeTest'
    jvmArgs '--enable-native-access=ALL-UNNAMED', '--enable-preview'

    def port = project.hasProperty('port') ? project.property('port') : '18515'
    args 'server', port
}

tasks.register('mellanoxClient', JavaExec) {
    description = 'Run Mellanox smoke test in client mode (requires -Phost=<server-ip>)'
    group = 'verification'

    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'io.surfworks.warpforge.io.test.MellanoxSmokeTest'
    jvmArgs '--enable-native-access=ALL-UNNAMED', '--enable-preview'

    doFirst {
        if (!project.hasProperty('host')) {
            throw new GradleException('Client mode requires -Phost=<server-ip>')
        }
    }

    def host = project.hasProperty('host') ? project.property('host') : 'localhost'
    def port = project.hasProperty('port') ? project.property('port') : '18515'
    args 'client', host, port
}

// ===== Documentation =====

javadoc {
    options {
        addBooleanOption('-enable-preview', true)
        addStringOption('-add-modules', 'jdk.incubator.vector')
        addStringOption('Xdoclint:none', '-quiet')
    }
}
