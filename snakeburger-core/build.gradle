plugins { id 'java-library' }

group = 'io.surfworks.snakeburger'
version = '0.0.1-SNAPSHOT'

repositories { mavenCentral() }

dependencies {
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.10.2'
    testImplementation 'org.junit.jupiter:junit-jupiter-params:5.10.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.10.2'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher:1.10.2'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(26)
    }
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
    // Use the Babylon JDK toolchain javac (26) and also force the incubator module on.
    options.compilerArgs.addAll(['--add-modules', 'jdk.incubator.code'])
}

tasks.withType(Test).configureEach {
    useJUnitPlatform()
    jvmArgs += ['--add-modules', 'jdk.incubator.code']
}

// Exclude cross-project integration tests from regular test task
test {
    useJUnitPlatform {
        excludeTags 'cross-project'
    }
}

// Cross-project integration tests: snakegrinder CLI → snakeburger parser
// Run with: ./gradlew :snakeburger-core:crossProjectTest
tasks.register('crossProjectTest', Test) {
    description = 'Run cross-project integration tests (snakegrinder → snakeburger workflow)'
    group = 'verification'

    // Use the same test sources as the main test task
    testClassesDirs = sourceSets.test.output.classesDirs
    classpath = sourceSets.test.runtimeClasspath

    useJUnitPlatform {
        includeTags 'cross-project'
    }
    jvmArgs += ['--add-modules', 'jdk.incubator.code']

    // Allow more time for native image execution
    systemProperty 'junit.jupiter.execution.timeout.default', '5m'

    testLogging {
        events 'passed', 'skipped', 'failed', 'standardOut'
        showStandardStreams = true
        exceptionFormat = 'full'
    }

    doFirst {
        // Check if snakegrinder native image exists
        def projectRoot = project.rootDir
        def distWrapper = file("${projectRoot}/snakegrinder-dist/build/dist/bin/snakegrinder")
        def nativeBinary = file("${projectRoot}/snakegrinder-cli/build/native/nativeCompile/snakegrinder")
        def appBinary = file("${projectRoot}/snakegrinder-dist/build/SnakeGrinder.app/Contents/MacOS/snakegrinder")

        if (!distWrapper.exists() && !nativeBinary.exists() && !appBinary.exists()) {
            logger.warn("WARN: snakegrinder native image not found. Run: ./gradlew :snakegrinder-dist:assembleDist")
            logger.warn("Tests will be skipped if binary is not available.")
        }
    }
}

// Add crossProjectTest to check task
check.dependsOn crossProjectTest
